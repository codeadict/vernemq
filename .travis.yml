services:
  - mysql
  - postgresql
  - mongodb
  - redis
  - memcached

env:
  global:
    - KERL_DEFAULT_INSTALL_DIR="$HOME/.kerl"

addons:
  apt:
    packages:
      - libsnappy-dev
  homebrew:
    update: false
    taps: mongodb/brew
    packages:
      - ccache
      - kerl
      - snappy
      - openssl@1.1
      - mysql
      - postgresql
      - redis
      - memcached
      - mongodb-community

before_install:
  # In macOS Catalina Apple enabled "stack checking" in its clang toolchain
  # which makes erlc segfault. See: https://github.com/kerl/kerl/issues/320
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export KERL_CONFIGURE_OPTIONS="--disable-hipe --enable-darwin-64bit --with-ssl=/usr/local/opt/openssl@1.1 --without-javac" ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export CFLAGS="-O2 -g -fno-stack-check -Wno-error=implicit-function-declaration" ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then kerl update releases ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then kerl list builds | grep ${OTP_VERSION} || travis_wait 45 kerl build ${OTP_VERSION} ${OTP_VERSION} ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then kerl list installations | grep ${OTP_VERSION} || kerl install ${OTP_VERSION} ; fi

install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      ulimit -n 2048 # by default travis osx has "ulimit -n 256"
      echo "[mysqld]" > $HOME/.my.cnf
      echo "secure_file_priv = \"\" ">> $HOME/.my.cnf
      echo "default_authentication_plugin = mysql_native_password" >> $HOME/.my.cnf
      echo "local_infile = 1" >> $HOME/.my.cnf
      brew services start redis
      brew services start memcached
      brew services start mysql
      brew services start mongodb-community
      export PG_DATA=$(brew --prefix)/var/postgres
      rm -rf $PG_DATA
      initdb $PG_DATA -E utf8
      pg_ctl -w start -l postgres.log --pgdata ${PG_DATA}
      createuser -s postgres
    fi

sudo: required
dist: trusty
language: erlang
jobs:
  include:
    - os: linux
      otp_release: 22.0
      env: OTP_VERSION=22.0
    - os: linux
      otp_release: 22.2
      env: OTP_VERSION=22.2
    - os: linux
      otp_release: 22.3
      env: OTP_VERSION=22.3
    - os: linux
      otp_release: 23.0
      env: OTP_VERSION=23.0
    # macOS Catalina
    - os: osx
      language: generic
      osx_image: xcode12
      env: OTP_VERSION=22.3
    - os: osx
      language: generic
      osx_image: xcode12
      env: OTP_VERSION=23.0

before_cache:
  - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then brew cleanup; fi

cache:
  directories:
    - $HOME/Library/Caches/Homebrew
    - /var/cache/apt
    - plts
    - plts_base
    - $HOME/.cache/rebar3
    - $HOME/.kerl
    - $HOME/.kerlrc

before_script:
  - if [ $TRAVIS_OS_NAME == osx ] ; then  . ${KERL_DEFAULT_INSTALL_DIR}/${OTP_VERSION}/activate ; fi
  - mysql -e "CREATE DATABASE vmq_test_database;" -uroot
  - mysql -e "CREATE USER 'vmq_test_user' IDENTIFIED BY 'vmq_test_password';" -uroot
  - mysql -e "GRANT ALL PRIVILEGES ON * . * TO 'vmq_test_user';" -uroot
  - psql -c "CREATE DATABASE vmq_test_database;" -U postgres
  - psql -c "CREATE USER vmq_test_user WITH PASSWORD 'vmq_test_password';" -U postgres
  - psql -c "GRANT ALL PRIVILEGES ON DATABASE vmq_test_database to vmq_test_user;" -U postgres
  - epmd -daemon
  - ./rebar3 dialyzer

script:
  - ./rebar3 as all_tests do dialyzer, eunit, ct
